# Staging-specific configuration overrides

service: kw-app-staging

builder:
  arch: arm64

servers:
  web:
    hosts:
      - pi5main.local

deploy_timeout: 180

proxy:
  ssl: false
  host: panel.taterniczek.pl
  healthcheck:
    path: /up
    interval: 10
    timeout: 10

env:
  clear:
    RAILS_ENV: staging
    RACK_ENV: staging
    DB_HOST: kw-app-staging-postgres
    RAILS_SERVE_STATIC_FILES: true

ssh:
  user: rege

accessories:
  postgres:
    service: kw-app-staging-postgres
    image: postgres:16.0
    host: pi5main.local
    port: "5433:5432"
    options:
      network: "kw-app-network"
    env:
      clear:
        POSTGRES_USER: staging_user
        POSTGRES_DB: kw_app_staging
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data-staging:/var/lib/postgresql/data

  redis:
    service: kw-app-staging-redis
    image: redis:7-alpine
    host: pi5main.local
    port: "6381:6379"
    options:
      network: "kw-app-network"
    env:
      secret:
        - REDIS_PASSWORD
    cmd: sh -c 'redis-server --requirepass "$$REDIS_PASSWORD" --appendonly yes --dir /data'
    directories:
      - redis-data-staging:/data