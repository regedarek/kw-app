service: kw-app-staging
image: regedarek/kw-app

builder:
  dockerfile: Dockerfile.production
  arch: arm64

servers:
  web:
    hosts:
      - pi5main.local
    options:
      network: "private"

proxy:
  ssl: false
  app_port: 3000
  host: pi5main.local
  healthcheck:
    path: /up
    interval: 10
    timeout: 10

registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Keep only 3 containers on host
retain_containers: 3

env:
  clear:
    RAILS_ENV: staging
    RACK_ENV: staging
    DB_HOST: kw-app-staging-postgres
    DB_PORT: 5432
    USE_CLOUD_STORAGE: false
    RAILS_SERVE_STATIC_FILES: true
  secret:
    - RAILS_MASTER_KEY

ssh:
  user: rege

accessories:
  postgres:
    image: postgres:16.0
    host: pi5main.local
    port: "5433:5432"
    env:
      clear:
        POSTGRES_USER: staging_user
        POSTGRES_DB: kw_app_staging
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data-staging:/var/lib/postgresql/data
    options:
      network: "private"

  redis:
    image: redis:7-alpine
    host: pi5main.local
    port: "6381:6379"
    cmd: "redis-server --requirepass ${REDIS_PASSWORD}"
    env:
      secret:
        - REDIS_PASSWORD
    directories:
      - redis-data-staging:/data
    options:
      network: "private"