service: kw-app-staging
image: regedarek/kw-app

builder:
  dockerfile: Dockerfile.production
  arch: arm64

servers:
  web:
    hosts:
      - localhost

deploy_timeout: 180

proxy:
  ssl: false
  app_port: 3000
  host: panel.taterniczek.pl
  healthcheck:
    path: /up
    interval: 10
    timeout: 10

registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

retain_containers: 3

env:
  clear:
    RAILS_ENV: staging
    RACK_ENV: staging
    DB_HOST: kw-app-staging-postgres
    DB_PORT: 5432
    RAILS_SERVE_STATIC_FILES: true
  secret:
    - RAILS_MASTER_KEY

ssh:
  user: rege

accessories:
  postgres:
    service: kw-app-staging-postgres
    image: postgres:16.0
    host: localhost
    port: "5433:5432"
    env:
      clear:
        POSTGRES_USER: staging_user
        POSTGRES_DB: kw_app_staging
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data-staging:/var/lib/postgresql/data

  redis:
    service: kw-app-staging-redis
    image: redis:7-alpine
    host: localhost
    port: "6381:6379"
    env:
      secret:
        - REDIS_PASSWORD
    cmd: sh -c 'redis-server --requirepass "$$REDIS_PASSWORD" --appendonly yes --dir /data'
    directories:
      - redis-data-staging:/data