# Base Kamal configuration - shared across all environments

service: kw-app
image: regedarek/kw-app

builder:
  dockerfile: Dockerfile.production
  arch: amd64

registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Keep only 3 containers on host
retain_containers: 3

# Boot configuration for zero-downtime deployments
boot:
  limit: 100%  # Deploy all servers simultaneously (only 1 server in production)
  wait: 10     # Wait 10 seconds after container starts before health checks begin

env:
  clear:
    DB_HOST: kw-app-postgres
    DB_PORT: 5432
  secret:
    - RAILS_MASTER_KEY

proxy:
  app_port: 3000
  healthcheck:
    path: /up
    interval: 2       # Check every 2 seconds during deployment
    timeout: 5        # Wait up to 5 seconds for each health check response

servers:
  web:
    options:
      network: "kw-app-network"