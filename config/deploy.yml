# Base Kamal configuration - shared across all environments

service: kw-app
image: regedarek/kw-app

builder:
  dockerfile: Dockerfile.production
  arch: amd64

registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Keep only 3 containers on host
retain_containers: 3

# Boot configuration for zero-downtime deployments
boot:
  limit: 100%  # Deploy all servers simultaneously (only 1 server in production)
  wait: 30     # Wait 30 seconds for app to boot before switching traffic

env:
  clear:
    DB_HOST: kw-app-postgres
    DB_PORT: 5432
  secret:
    - RAILS_MASTER_KEY

proxy:
  app_port: 3000
  healthcheck:
    path: /up
    interval: 10      # Check every 10 seconds (less aggressive)
    timeout: 10       # Allow 10 seconds for response (Rails boot time)
    max_attempts: 10  # Try 10 times before giving up (100 seconds total)

servers:
  web:
    options:
      network: "kw-app-network"