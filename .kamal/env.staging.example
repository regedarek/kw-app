#!/bin/bash
# Local deployment to staging - fetch secrets from Bitwarden Secrets Manager
# 
# PREREQUISITES:
# 1. Install Bitwarden Secrets Manager CLI (bws):
#    brew install bitwarden/sm/bws
#    Or download from: https://github.com/bitwarden/sdk-sm/releases
#
# 2. Get your access token from Bitwarden Secrets Manager:
#    - Go to https://vault.bitwarden.com (Secrets Manager)
#    - Navigate to: kw-app â†’ Service Accounts â†’ kw-app
#    - Copy an existing access token OR create a new one
#    - Save it as: export BWS_ACCESS_TOKEN="your-token-here"
#
# USAGE:
#   1. Set your access token: export BWS_ACCESS_TOKEN="0.xxx..."
#   2. Source this file: source .kamal/env.staging.example
#   3. Deploy: kamal deploy -d staging

# Check if BWS CLI is installed
if ! command -v bws &> /dev/null; then
    echo "âŒ Bitwarden Secrets Manager CLI (bws) is not installed"
    echo ""
    echo "Install with:"
    echo "  brew install bitwarden/sm/bws"
    echo ""
    echo "Or download from: https://github.com/bitwarden/sdk-sm/releases"
    return 1 2>/dev/null || exit 1
fi

# Check if access token is set
if [ -z "$BWS_ACCESS_TOKEN" ]; then
    echo "âŒ BWS_ACCESS_TOKEN is not set"
    echo ""
    echo "Get your access token from Bitwarden Secrets Manager:"
    echo "  1. Go to https://vault.bitwarden.com"
    echo "  2. Navigate to: kw-app â†’ Service Accounts â†’ kw-app"
    echo "  3. Copy the access token"
    echo ""
    echo "Then run:"
    echo "  export BWS_ACCESS_TOKEN=\"your-token-here\""
    return 1 2>/dev/null || exit 1
fi

echo "ðŸ” Fetching secrets from Bitwarden Secrets Manager..."

# Fetch secrets by UUID (same UUIDs used in GitHub Actions)
# Replace these UUIDs with your actual secret UUIDs from Bitwarden
export KAMAL_REGISTRY_USERNAME=$(bws secret get 6e77be63-a052-4594-9585-b3da01100ce9 --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
export KAMAL_REGISTRY_PASSWORD=$(bws secret get 6ff8b019-a3e4-4571-85fc-b3da01106838 --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
export RAILS_MASTER_KEY=$(bws secret get 79cdec0b-a73e-4f31-aabe-b3da0110963a --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
export POSTGRES_PASSWORD=$(bws secret get 5f418769-a3ee-46d3-87bf-b3da0110cd71 --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
export REDIS_PASSWORD=$(bws secret get b4b3b0ce-46fe-4068-a477-b3da0110f721 --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')

# Verify secrets were fetched
if [[ -z "$KAMAL_REGISTRY_USERNAME" || -z "$KAMAL_REGISTRY_PASSWORD" || -z "$RAILS_MASTER_KEY" || -z "$POSTGRES_PASSWORD" || -z "$REDIS_PASSWORD" ]]; then
    echo "âŒ Failed to fetch one or more secrets"
    echo ""
    echo "Check that:"
    echo "  1. Your BWS_ACCESS_TOKEN is valid"
    echo "  2. The secret UUIDs are correct"
    echo "  3. The service account has access to all secrets"
    return 1 2>/dev/null || exit 1
fi

echo "âœ… All secrets fetched successfully!"
echo ""
echo "You can now run:"
echo "  kamal deploy -d staging"