#!/bin/bash
# Kamal secrets - local development
# Automatically fetches secrets from Bitwarden Secrets Manager for local deployments
# For CI/CD, this file is ignored and GitHub Actions injects secrets directly

# Check if running in CI/CD (GitHub Actions handles secrets)
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
  # In CI/CD, secrets come from environment (set by GitHub Actions workflow)
  export KAMAL_REGISTRY_USERNAME="${KAMAL_REGISTRY_USERNAME}"
  export KAMAL_REGISTRY_PASSWORD="${KAMAL_REGISTRY_PASSWORD}"
  export RAILS_MASTER_KEY="${RAILS_MASTER_KEY}"
  export POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
  export REDIS_PASSWORD="${REDIS_PASSWORD}"
  exit 0
fi

# Local development - fetch from Bitwarden Secrets Manager
if ! command -v bws &> /dev/null; then
  echo "❌ Bitwarden Secrets Manager CLI (bws) not installed" >&2
  echo "Install: brew install bitwarden/sm/bws" >&2
  exit 1
fi

if [ -z "$BWS_ACCESS_TOKEN" ]; then
  echo "❌ BWS_ACCESS_TOKEN not set" >&2
  echo "Get token from: https://vault.bitwarden.com → kw-app → Service Accounts" >&2
  echo "Then: export BWS_ACCESS_TOKEN=\"your-token\"" >&2
  exit 1
fi

# Determine which environment (staging or production) based on Kamal destination
# Default to staging if not specified
DESTINATION="${KAMAL_DESTINATION:-staging}"

if [ "$DESTINATION" = "production" ]; then
  # Production secrets
  export KAMAL_REGISTRY_USERNAME=$(bws secret get 6e77be63-a052-4594-9585-b3da01100ce9 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export KAMAL_REGISTRY_PASSWORD=$(bws secret get 6ff8b019-a3e4-4571-85fc-b3da01106838 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export RAILS_MASTER_KEY=$(bws secret get 519419f3-6bb7-4ce6-8132-b3da0119bf76 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export POSTGRES_PASSWORD=$(bws secret get 9c80203f-f8c2-4b5d-8d4b-b3da0119d394 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export REDIS_PASSWORD=$(bws secret get 8ca74ff6-e6bd-4884-b45b-b3da0119f2a7 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
else
  # Staging secrets (default)
  export KAMAL_REGISTRY_USERNAME=$(bws secret get 6e77be63-a052-4594-9585-b3da01100ce9 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export KAMAL_REGISTRY_PASSWORD=$(bws secret get 6ff8b019-a3e4-4571-85fc-b3da01106838 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export RAILS_MASTER_KEY=$(bws secret get 79cdec0b-a73e-4f31-aabe-b3da0110963a --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export POSTGRES_PASSWORD=$(bws secret get 5f418769-a3ee-46d3-87bf-b3da0110cd71 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
  export REDIS_PASSWORD=$(bws secret get b4b3b0ce-46fe-4068-a477-b3da0110f721 --access-token "$BWS_ACCESS_TOKEN" 2>/dev/null | jq -r '.value')
fi

# Verify all secrets were fetched
if [[ -z "$KAMAL_REGISTRY_USERNAME" ]] || [[ -z "$KAMAL_REGISTRY_PASSWORD" ]] || [[ -z "$RAILS_MASTER_KEY" ]] || [[ -z "$POSTGRES_PASSWORD" ]] || [[ -z "$REDIS_PASSWORD" ]]; then
  echo "❌ Failed to fetch secrets from Bitwarden for $DESTINATION environment" >&2
  exit 1
fi