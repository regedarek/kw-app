#!/bin/bash
set -e

# Database Migration Script: Old Prod â†’ New Prod
# This script downloads a dump from the old production server,
# uploads it to the new production server, and restores it.

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
OLD_PROD_HOST="51.68.141.247"
OLD_PROD_USER="deploy"
OLD_PROD_DUMP_DIR="/home/deploy/baza_dump/sql"

NEW_PROD_HOST="146.59.44.70"
NEW_PROD_USER="ubuntu"
NEW_PROD_DUMP_DIR="/tmp"

POSTGRES_USER="production_user"
POSTGRES_DB="kw_app_production"

LOCAL_TEMP_DIR="/tmp/kw-app-migration"

# Functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Migrate database from old production server to new production server.

OPTIONS:
    --dump FILENAME     Specify dump file name (default: latest)
    --list              List available dumps on old server
    --dry-run           Show what would be done without executing
    --skip-download     Use existing dump in $LOCAL_TEMP_DIR
    --help