name: Deploy Staging
concurrency:
  group: staging
  cancel-in-progress: true

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    env:
      DOCKER_BUILDKIT: 1

    steps:
      - uses: actions/checkout@v4
      
      # Install Bitwarden Secrets Manager CLI
      - name: Install Bitwarden Secrets Manager CLI
        run: |
          if ! command -v bws &> /dev/null; then
            echo "Installing Bitwarden Secrets Manager CLI..."
            
            # Get latest version
            BWS_VERSION=$(curl -s https://api.github.com/repos/bitwarden/sdk/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
            echo "Latest BWS version: $BWS_VERSION"
            
            # Download ARM64 binary
            curl -L -o bws-aarch64-unknown-linux-gnu.zip \
              "https://github.com/bitwarden/sdk/releases/download/${BWS_VERSION}/bws-aarch64-unknown-linux-gnu-${BWS_VERSION}.zip"
            
            unzip -o bws-aarch64-unknown-linux-gnu.zip
            chmod +x bws
            sudo mv bws /usr/local/bin/
            rm bws-aarch64-unknown-linux-gnu.zip
          else
            echo "✅ Bitwarden Secrets Manager CLI already installed"
          fi
          
          bws --version
      
      # Fetch secrets from Bitwarden Secrets Manager
      - name: Get Secrets from Bitwarden
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BW_ACCESS_TOKEN }}
        run: |
          echo "Fetching secrets from Bitwarden Secrets Manager..."
          
          # Fetch each secret by ID and export as environment variable
          export KAMAL_REGISTRY_USERNAME=$(bws secret get ${{ secrets.BW_SECRET_REGISTRY_USERNAME }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          export KAMAL_REGISTRY_PASSWORD=$(bws secret get ${{ secrets.BW_SECRET_REGISTRY_PASSWORD }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          export RAILS_MASTER_KEY=$(bws secret get ${{ secrets.BW_SECRET_STAGING_MASTER_KEY }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          export POSTGRES_PASSWORD=$(bws secret get ${{ secrets.BW_SECRET_STAGING_POSTGRES_PASSWORD }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          export REDIS_PASSWORD=$(bws secret get ${{ secrets.BW_SECRET_STAGING_REDIS_PASSWORD }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          
          # Save to GITHUB_ENV for subsequent steps
          echo "KAMAL_REGISTRY_USERNAME=$KAMAL_REGISTRY_USERNAME" >> $GITHUB_ENV
          echo "KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD" >> $GITHUB_ENV
          echo "RAILS_MASTER_KEY=$RAILS_MASTER_KEY" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> $GITHUB_ENV
          echo "REDIS_PASSWORD=$REDIS_PASSWORD" >> $GITHUB_ENV
          
          # Verify secrets are set (without exposing values)
          [[ -n "$KAMAL_REGISTRY_USERNAME" ]] && echo "✅ KAMAL_REGISTRY_USERNAME fetched" || { echo "❌ KAMAL_REGISTRY_USERNAME missing"; exit 1; }
          [[ -n "$KAMAL_REGISTRY_PASSWORD" ]] && echo "✅ KAMAL_REGISTRY_PASSWORD fetched" || { echo "❌ KAMAL_REGISTRY_PASSWORD missing"; exit 1; }
          [[ -n "$RAILS_MASTER_KEY" ]] && echo "✅ RAILS_MASTER_KEY fetched (length: ${#RAILS_MASTER_KEY})" || { echo "❌ RAILS_MASTER_KEY missing"; exit 1; }
          [[ -n "$POSTGRES_PASSWORD" ]] && echo "✅ POSTGRES_PASSWORD fetched" || { echo "❌ POSTGRES_PASSWORD missing"; exit 1; }
          [[ -n "$REDIS_PASSWORD" ]] && echo "✅ REDIS_PASSWORD fetched" || { echo "❌ REDIS_PASSWORD missing"; exit 1; }
          
          echo ""
          echo "✅ All secrets fetched successfully from Bitwarden Secrets Manager!"
      
      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          else
            echo "✅ jq already installed"
          fi
      
      - name: Check and install Ruby if needed
        run: |
          if ! command -v ruby &> /dev/null; then
            echo "Ruby not found, installing..."
            sudo apt-get update -qq
            sudo apt-get install -y ruby-full
          fi
          ruby -v
      
      - name: Setup Ruby gem paths
        run: |
          echo "GEM_HOME=$(ruby -r rubygems -e 'puts Gem.user_dir')" >> $GITHUB_ENV
          echo "$(ruby -r rubygems -e 'puts Gem.user_dir')/bin" >> $GITHUB_PATH
      
      - name: Install Kamal
        run: |
          if ! command -v kamal &> /dev/null; then
            gem install kamal --no-document
          fi
          kamal version
      
      - name: Login to Docker Hub
        run: |
          echo "${{ env.KAMAL_REGISTRY_PASSWORD }}" | docker login -u "${{ env.KAMAL_REGISTRY_USERNAME }}" --password-stdin
      
      - name: Release deploy lock
        run: kamal lock release -d staging || true
      
      - name: Remove stale kamal-proxy routes
        run: docker exec kamal-proxy kamal-proxy remove kw-app-staging-web-staging 2>&1 || echo "No existing routes to remove"
      
      - name: Boot accessories (postgres and redis)
        run: |
          kamal accessory boot postgres -d staging || echo "Postgres already running"
          kamal accessory boot redis -d staging || echo "Redis already running"
      
      - name: Deploy to staging
        run: kamal deploy -d staging
      
      - name: Cleanup old Docker images
        run: kamal prune all -d staging || true
        continue-on-error: true