name: Deploy Staging
concurrency:
  group: staging
  cancel-in-progress: true

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # Runs on Pi itself
    env:
      DOCKER_BUILDKIT: 1

    steps:
      - uses: actions/checkout@v4
      
      # Install dependencies (self-hosted runner may already have these)
      - name: Install jq and setup Bitwarden CLI via Docker
        run: |
          # Install jq for JSON parsing
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          else
            echo "âœ… jq already installed"
          fi
          
          # Remove old bw binaries if present
          sudo rm -f /usr/local/bin/bw
          
          # Create Bitwarden CLI Docker wrapper
          sudo tee /usr/local/bin/bw > /dev/null <<'EOF'
          #!/bin/bash
          # Bitwarden CLI wrapper using Docker
          docker run --rm -i \
            -v ~/.config/Bitwarden\ CLI:/root/.config/Bitwarden\ CLI \
            -e BW_SESSION="${BW_SESSION}" \
            bitwarden/cli:latest "$@"
          EOF
          
          sudo chmod +x /usr/local/bin/bw
          
          # Pull Bitwarden CLI Docker image
          docker pull bitwarden/cli:latest
          
          echo "Bitwarden CLI version: $(bw --version)"
          echo "jq version: $(jq --version)"
      
      # Login and unlock Bitwarden, export BW_SESSION for Kamal secrets files
      - name: Authenticate with Bitwarden
        env:
          BW_CLIENTID: ${{ secrets.BW_CLIENTID }}
          BW_CLIENTSECRET: ${{ secrets.BW_CLIENTSECRET }}
          BW_PASSWORD: ${{ secrets.BW_PASSWORD }}
        run: |
          # Login with API credentials
          bw login --apikey
          
          # Unlock and get session token
          export BW_SESSION=$(bw unlock --passwordenv BW_PASSWORD --raw)
          echo "BW_SESSION=$BW_SESSION" >> $GITHUB_ENV
          
          # Verify we're unlocked
          bw unlock --check
          
          echo "âœ… Bitwarden authenticated successfully"
      
      # Test that secrets can be fetched (without deploying)
      - name: Test secret fetching
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: |
          echo "ðŸ§ª Testing secret fetching from Bitwarden..."
          
          # Source the secrets file to test fetching
          source .kamal/secrets.staging
          
          # Verify secrets are set (without exposing values)
          [[ -n "$KAMAL_REGISTRY_USERNAME" ]] && echo "âœ… KAMAL_REGISTRY_USERNAME fetched" || { echo "âŒ KAMAL_REGISTRY_USERNAME missing"; exit 1; }
          [[ -n "$KAMAL_REGISTRY_PASSWORD" ]] && echo "âœ… KAMAL_REGISTRY_PASSWORD fetched" || { echo "âŒ KAMAL_REGISTRY_PASSWORD missing"; exit 1; }
          [[ -n "$RAILS_MASTER_KEY" ]] && echo "âœ… RAILS_MASTER_KEY fetched (length: ${#RAILS_MASTER_KEY})" || { echo "âŒ RAILS_MASTER_KEY missing"; exit 1; }
          [[ -n "$POSTGRES_PASSWORD" ]] && echo "âœ… POSTGRES_PASSWORD fetched" || { echo "âŒ POSTGRES_PASSWORD missing"; exit 1; }
          [[ -n "$REDIS_PASSWORD" ]] && echo "âœ… REDIS_PASSWORD fetched" || { echo "âŒ REDIS_PASSWORD missing"; exit 1; }
          
          echo ""
          echo "âœ… All secrets fetched successfully from Bitwarden!"
      
      - name: Check and install Ruby if needed
        run: |
          if ! command -v ruby &> /dev/null; then
            echo "Ruby not found, installing..."
            sudo apt-get update -qq
            sudo apt-get install -y ruby-full
          fi
          ruby -v
      
      - name: Setup Ruby gem paths
        run: |
          echo "GEM_HOME=$(ruby -r rubygems -e 'puts Gem.user_dir')" >> $GITHUB_ENV
          echo "$(ruby -r rubygems -e 'puts Gem.user_dir')/bin" >> $GITHUB_PATH
      
      - name: Install Kamal
        run: |
          if ! command -v kamal &> /dev/null; then
            gem install kamal --no-document
          fi
          kamal version
      
      - name: Login to Docker Hub
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: |
          # Fetch registry credentials from Bitwarden
          source .kamal/secrets.staging
          echo "$KAMAL_REGISTRY_PASSWORD" | docker login -u "$KAMAL_REGISTRY_USERNAME" --password-stdin
      
      - name: Release deploy lock
        run: kamal lock release -d staging || true
      
      - name: Remove stale kamal-proxy routes
        run: docker exec kamal-proxy kamal-proxy remove kw-app-staging-web-staging 2>&1 || echo "No existing routes to remove"
      
      - name: Boot accessories (postgres and redis)
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: |
          kamal accessory boot postgres -d staging || echo "Postgres already running"
          kamal accessory boot redis -d staging || echo "Redis already running"
      
      - name: Deploy to staging
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: kamal deploy -d staging
      
      - name: Cleanup old Docker images
        run: kamal prune all -d staging || true
        continue-on-error: true
      
      # Logout from Bitwarden
      - name: Logout from Bitwarden
        if: always()
        run: bw logout || true