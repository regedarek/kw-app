name: Test Bitwarden Secrets
on:
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install jq and setup Bitwarden CLI via Docker
        run: |
          # Install jq
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          fi
          
          # Remove old bw binaries
          sudo rm -f /usr/local/bin/bw
          
          # Create Bitwarden CLI Docker wrapper
          sudo tee /usr/local/bin/bw > /dev/null <<'SCRIPT'
          #!/bin/bash
          docker run --rm -i \
            -v ~/.config/Bitwarden\ CLI:/root/.config/Bitwarden\ CLI \
            -e BW_SESSION="${BW_SESSION}" \
            bitwarden/cli:latest "$@"
SCRIPT
          
          sudo chmod +x /usr/local/bin/bw
          
          # Pull Bitwarden CLI Docker image
          docker pull bitwarden/cli:latest
          
          echo "Bitwarden CLI version: $(bw --version)"
          echo "jq version: $(jq --version)"
      
      - name: Authenticate with Bitwarden
        env:
          BW_CLIENTID: ${{ secrets.BW_CLIENTID }}
          BW_CLIENTSECRET: ${{ secrets.BW_CLIENTSECRET }}
          BW_PASSWORD: ${{ secrets.BW_PASSWORD }}
        run: |
          echo "üîê Authenticating with Bitwarden..."
          bw login --apikey
          
          export BW_SESSION=$(bw unlock --passwordenv BW_PASSWORD --raw)
          echo "BW_SESSION=$BW_SESSION" >> $GITHUB_ENV
          
          bw unlock --check
          echo "‚úÖ Bitwarden authenticated successfully"
      
      - name: Test secret fetching
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: |
          echo "üß™ Testing secret fetching from Bitwarden..."
          
          source .kamal/secrets.staging
          
          [[ -n "$KAMAL_REGISTRY_USERNAME" ]] && echo "‚úÖ KAMAL_REGISTRY_USERNAME fetched" || { echo "‚ùå KAMAL_REGISTRY_USERNAME missing"; exit 1; }
          [[ -n "$KAMAL_REGISTRY_PASSWORD" ]] && echo "‚úÖ KAMAL_REGISTRY_PASSWORD fetched" || { echo "‚ùå KAMAL_REGISTRY_PASSWORD missing"; exit 1; }
          [[ -n "$RAILS_MASTER_KEY" ]] && echo "‚úÖ RAILS_MASTER_KEY fetched (length: ${#RAILS_MASTER_KEY})" || { echo "‚ùå RAILS_MASTER_KEY missing"; exit 1; }
          [[ -n "$POSTGRES_PASSWORD" ]] && echo "‚úÖ POSTGRES_PASSWORD fetched" || { echo "‚ùå POSTGRES_PASSWORD missing"; exit 1; }
          [[ -n "$REDIS_PASSWORD" ]] && echo "‚úÖ REDIS_PASSWORD fetched" || { echo "‚ùå REDIS_PASSWORD missing"; exit 1; }
          
          echo ""
          echo "‚úÖ All secrets fetched successfully from Bitwarden!"
      
      - name: Logout from Bitwarden
        if: always()
        run: bw logout || true
