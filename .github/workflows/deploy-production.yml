name: Deploy Production
concurrency:
  group: production
  cancel-in-progress: false

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1

    steps:
      - uses: actions/checkout@v4
      
      # Install dependencies
      - name: Install Bitwarden CLI and jq
        run: |
          # Install jq for JSON parsing
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          else
            echo "‚úÖ jq already installed"
          fi
          
          # Install Bitwarden CLI
          if ! command -v bw &> /dev/null; then
            echo "Installing Bitwarden CLI..."
            wget -O bw.zip "https://vault.bitwarden.com/download/?app=cli&platform=linux"
            unzip -o bw.zip
            chmod +x bw
            sudo mv bw /usr/local/bin/
          else
            echo "‚úÖ Bitwarden CLI already installed"
          fi
          
          echo "Bitwarden CLI version: $(bw --version)"
          echo "jq version: $(jq --version)"
      
      # Login and unlock Bitwarden, export BW_SESSION for Kamal secrets files
      - name: Authenticate with Bitwarden
        env:
          BW_CLIENTID: ${{ secrets.BW_CLIENTID }}
          BW_CLIENTSECRET: ${{ secrets.BW_CLIENTSECRET }}
          BW_PASSWORD: ${{ secrets.BW_PASSWORD }}
        run: |
          # Logout first if already logged in
          bw logout || true
          
          # Login with API credentials
          bw login --apikey
          
          # Unlock and get session token
          export BW_SESSION=$(bw unlock --passwordenv BW_PASSWORD --raw)
          echo "BW_SESSION=$BW_SESSION" >> $GITHUB_ENV
          
          # Verify we're unlocked
          bw unlock --check
          
          echo "‚úÖ Bitwarden authenticated successfully"
      
      # Test that secrets can be fetched (without deploying)
      - name: Test secret fetching
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: |
          echo "üß™ Testing secret fetching from Bitwarden..."
          
          # Source the secrets file to test fetching
          source .kamal/secrets.production
          
          # Verify secrets are set (without exposing values)
          [[ -n "$KAMAL_REGISTRY_USERNAME" ]] && echo "‚úÖ KAMAL_REGISTRY_USERNAME fetched" || { echo "‚ùå KAMAL_REGISTRY_USERNAME missing"; exit 1; }
          [[ -n "$KAMAL_REGISTRY_PASSWORD" ]] && echo "‚úÖ KAMAL_REGISTRY_PASSWORD fetched" || { echo "‚ùå KAMAL_REGISTRY_PASSWORD missing"; exit 1; }
          [[ -n "$RAILS_MASTER_KEY" ]] && echo "‚úÖ RAILS_MASTER_KEY fetched (length: ${#RAILS_MASTER_KEY})" || { echo "‚ùå RAILS_MASTER_KEY missing"; exit 1; }
          [[ -n "$POSTGRES_PASSWORD" ]] && echo "‚úÖ POSTGRES_PASSWORD fetched" || { echo "‚ùå POSTGRES_PASSWORD missing"; exit 1; }
          [[ -n "$REDIS_PASSWORD" ]] && echo "‚úÖ REDIS_PASSWORD fetched" || { echo "‚ùå REDIS_PASSWORD missing"; exit 1; }
          
          echo ""
          echo "‚úÖ All secrets fetched successfully from Bitwarden!"
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'
          bundler-cache: false
      
      - name: Install Kamal
        run: |
          gem install kamal --no-document
          kamal version
      
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Verify secret is present
          if [ -z "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Error: PRODUCTION_SSH_PRIVATE_KEY secret is not set"
            echo "Please add this secret in GitHub repository settings"
            exit 1
          fi
          
          echo "‚úÖ PRODUCTION_SSH_PRIVATE_KEY secret is present"
          
          # Write SSH private key (ensure proper newlines)
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/kamal_production_ed25519
          
          # Ensure the key ends with a newline
          echo "" >> ~/.ssh/kamal_production_ed25519
          
          # Set correct permissions
          chmod 600 ~/.ssh/kamal_production_ed25519
          
          # Verify key format
          if ! ssh-keygen -l -f ~/.ssh/kamal_production_ed25519 > /dev/null 2>&1; then
            echo "‚ùå Error: SSH key is not valid"
            echo "Key fingerprint check failed. Please verify PRODUCTION_SSH_PRIVATE_KEY secret."
            exit 1
          fi
          
          echo "‚úÖ SSH key validated successfully"
          
          # Add server to known hosts
          ssh-keyscan -H 146.59.44.70 >> ~/.ssh/known_hosts
      
      - name: Configure SSH for Kamal
        run: |
          cat > ~/.ssh/config << 'EOF'
          Host 146.59.44.70
            User ubuntu
            IdentityFile ~/.ssh/kamal_production_ed25519
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes
          EOF
          chmod 600 ~/.ssh/config
          
          echo "SSH configuration:"
          cat ~/.ssh/config
      
      - name: Start SSH agent and add key
        run: |
          # Start SSH agent
          eval $(ssh-agent -s)
          
          # Add the SSH key to the agent
          ssh-add ~/.ssh/kamal_production_ed25519
          
          # Export SSH_AUTH_SOCK for subsequent steps
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV
          
          echo "‚úÖ SSH agent started and key added"
      
      - name: Test SSH connection
        run: |
          echo "Testing SSH connection to production server..."
          if ssh -o ConnectTimeout=10 -o BatchMode=yes ubuntu@146.59.44.70 'echo "‚úÖ SSH connection successful"'; then
            echo "SSH authentication working correctly"
          else
            echo "‚ùå SSH connection failed"
            echo "Please verify:"
            echo "  1. PRODUCTION_SSH_PRIVATE_KEY secret is set correctly"
            echo "  2. The corresponding public key is in ~/.ssh/authorized_keys on the server"
            echo "  3. The server allows SSH key authentication"
            exit 1
          fi
      
      - name: Login to Docker Hub
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: |
          # Fetch registry credentials from Bitwarden
          source .kamal/secrets.production
          echo "$KAMAL_REGISTRY_PASSWORD" | docker login -u "$KAMAL_REGISTRY_USERNAME" --password-stdin
      
      - name: Release deploy lock
        run: kamal lock release -d production || true
      
      - name: Deploy to production
        env:
          BW_SESSION: ${{ env.BW_SESSION }}
        run: kamal deploy -d production
      
      - name: Cleanup old Docker images
        run: kamal prune all -d production || true
        continue-on-error: true
      
      # Logout from Bitwarden
      - name: Logout from Bitwarden
        if: always()
        run: bw logout || true