services:
  app:
    command: ./bin/thrust ./bin/rails server -p 3002 -b 0.0.0.0
    build: .
    environment:
      - DB_HOST=postgres
      - PGUSER=dev-user
      - DB_PASSWORD=dev-password
      - DB_USER=dev-user
      - DB_USERNAME=dev-user
      - REDIS_URL_SIDEKIQ=redis://redis:6379/1
    volumes:
      - .:/rails
      - kw-app-cache:/rails/tmp/cache
    ports:
      - "3002:3002"
    depends_on:
      - postgres
      - redis
      - mailcatcher
    tty: true
    stdin_open: true
    networks:
      - my_local_dev_network

  postgres:
    container_name: kw-app-postgres-10
    image: 'postgres:10.3-alpine'
    volumes:
      - kw-app-postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=dev-user
      - POSTGRES_PASSWORD=dev-password
      - PG_USER=dev-user
    ports:
        - "5432:5432"
    networks:
      - my_local_dev_network

  sidekiq:
    container_name: kw-app-sidekiq
    depends_on:
      - postgres
      - redis
    build: .
    command: ./bin/sidekiq -C config/sidekiq.yml
    volumes:
      - .:/rails
      - .:/rails/tmp/cache
    environment:
      - DB_HOST=postgres
      - PGUSER=dev-user
      - DB_PASSWORD=dev-password
      - DB_USER=dev-user
      - DB_USERNAME=dev-user
      - REDIS_URL_SIDEKIQ=redis://redis:6379/1
    stdin_open: true
    tty: true
    networks:
      - my_local_dev_network

  mailcatcher:
    image: schickling/mailcatcher
    ports:
      - "1025:1025"
      - "1080:1080"
    networks:
      - my_local_dev_network

  redis:
    container_name: kw-app-redis
    image: 'redis:7-alpine'
    command: redis-server  --requirepass +eA8tga96sbquDe9CLL3yUZMNdHM6prSwD6kj1vXO4nzPPudDkxh4U+/LMtOWd+Wd72s9MnXNZqCKZeh
    ports:
      - '6379:6379'
    volumes:
      - kw-app-redis-data:/var/lib/redis/data
    sysctls:
      - net.core.somaxconn=4096
    networks:
      - my_local_dev_network

volumes:
  kw-app-redis-data:
  kw-app-postgres:
  kw-app-cache:

networks:
  my_local_dev_network:
    name: my_local_dev_network
